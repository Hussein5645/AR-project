<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model & 360 Image Viewer (Google Drive)</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pannellum/build/pannellum.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum/build/pannellum.css">

    <style>
        body[lang="ar"] {
            direction: rtl;
        }
    
        body[lang="en"] {
            direction: ltr;
        }
    
        #lang-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            background-color: #444;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            z-index: 20;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
    
        #lang-toggle:hover {
            background-color: #555;
        }
    
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #121212;
            color: #fff;
        }
    
        #model-viewer, #pano-viewer {
            width: 100vw;
            height: 100vh;
            background: #121212;
            display: none;
        }
    
        #controls {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 8px;
            z-index: 10;
            text-align: center;
            width: 90vw;
            max-width: 500px;
            height: 60vh;
            max-height: 400px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: all 0.4s ease;
        }
    
        #controls.shrink {
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 300px;
            height: 70px;
        }
    
        #controls-toggle-button {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #444 url('icon/show.png') center center no-repeat;
            background-size: 20px 20px;
            cursor: pointer;
            z-index: 15;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
    
        #controls-toggle-button:hover {
            background-color: #555;
            transform: scale(1.1);
        }
    
        #upload-Button {
            position: fixed;
            bottom: 10px;
            right: 70px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #444 url('icon/upload.png') center center no-repeat;
            background-size: 20px 20px;
            cursor: pointer;
            z-index: 15;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
    
        #upload-Button:hover {
            background-color: #555;
            transform: scale(1.1);
        }
    
        #controls.hidden {
            display: none;
        }
    
        #controls-toggle-button.hide-icon {
            background-image: url('icon/hide.png');
        }
    
        #q-placeholder {
            display: none;
            width: 100px;
            height: 100px;
            background: #555;
            border-radius: 10px;
            margin: 20px auto;
            position: relative;
        }
    
        input[type="text"] {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: #333;
            color: #fff;
            margin-bottom: 10px;
            margin-right: 50px;
            width: calc(80% - 20px);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
    
        input[type="text"]:focus {
            background: #444;
            box-shadow: 0 0 5px #007bff;
            outline: none;
        }
    
        button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: #fff;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
    
        button:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
    
        #toggle-button {
            background: #444 url('icon/shrink.png') center center no-repeat;
            background-size: 20px 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            margin-top: 10px;
            position: fixed;
            right: 10px;
            top: 8px;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
    
        #toggle-button:hover {
            transform: scale(1.1);
            background-color: #555;
        }
    
        #controls.shrink #toggle-button {
            background-image: url('icon/expand.png');
        }
    
        #ar-button {
            background: #28a745 url('icon/ar.png') 10px center no-repeat;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            padding: 12px 20px;
            border-radius: 5px;
            display: block;
            cursor: pointer;
            background-size: 20px 20px;
            padding-left: 40px;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
    
        #ar-button:hover {
            background: #218838;
            transform: scale(1.05);
        }
    
        #save-qr-button {
            display: none;
            background: #ffc107 url('icon/save.png') 10px center no-repeat;
            color: #000;
            padding: 12px 20px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 230px;
            background-size: 20px 20px;
            padding-left: 40px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
    
        #save-qr-button:hover {
            background: #e0a800;
            transform: scale(1.05);
        }
    
        #qrcode {
            margin-top: 10px;
        }
    
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.5em;
            z-index: 20;
            transition: opacity 0.5s ease;
        }
    
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
    
</head>
<body lang="ar"> <!-- Default to Arabic -->

    <!-- Language toggle button -->
    <button id="lang-toggle" onclick="toggleLanguage()">English</button>

    <div id="loading-screen" class="hidden">جار التحميل...</div> <!-- Loading text in Arabic -->
    
    <!-- Main content: 3D Model Viewer, AR button, QR code placeholder, etc. -->
    <model-viewer id="model-viewer" 
        alt="3D model" 
        auto-rotate 
        camera-controls 
        shadow-intensity="1" 
        exposure="1" 
        ar 
        ar-modes="webxr scene-viewer quick-look"
        ar-status="session-started"
        ar-scale="auto"
        src="">
    </model-viewer>
    <div id="pano-viewer"></div>

    <button id="controls-toggle-button" onclick="toggleControlsVisibility()"></button>
    <button id="upload-Button" onclick="window.location.href='upload.html'"></button>

    <div id="controls">
        <button id="toggle-button" onclick="toggleControls()"></button>
        <input type="text" id="model-prefix" placeholder="أدخل معرف الملف" oninput="toggleButton()"> <!-- Placeholder in Arabic -->
        <select id="file-type" style="padding: 10px; border:none; border-radius:5px; background:#333; color:#fff; margin-bottom:10px; width:calc(80% - 20px);">
            <option value="model">نموذج ثلاثي الأبعاد (.glb)</option>
            <option value="panorama">صورة بانورامية (jpg/png)</option>
        </select>
        <button id="load-button" style="display: none;" onclick="loadModel()">تحميل المحتوى</button>
        <div id="error-box" style="display:none; background:#922; color:#fff; padding:10px; border-radius:6px; font-size:13px; line-height:1.4; text-align:right; max-height:150px; overflow:auto;">خطأ في التحميل. غالباً مشكلة CORS مع Google Drive.
        <br>الحل:
        <br>1. ضع النموذج داخل المستودع واستخدم رابط raw: <code>https://raw.githubusercontent.com/USERNAME/REPO/BRANCH/path/file.glb</code>
        <br>2. أو استخدم jsDelivr: <code>https://cdn.jsdelivr.net/gh/USERNAME/REPO@BRANCH/path/file.glb</code>
        <br>3. أو استضفه على خدمة تدعم CORS (مثل Cloudflare R2).
        <br>يمكن لصق رابط مباشر كامل بدل المعرف وسيتعامل معه النظام.
        </div>

        <div id="qr-placeholder">
            <canvas id="qrcode" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);   margin-top: 30px;"></canvas>
        </div>
        <div id="save-qr-button">حفظ   QR CODE </div> <!-- Save QR text in Arabic -->
        <button id="ar-button" style="display: none;" onclick="openAR()">عرض في الواقع المعزز</button> <!-- AR button text in Arabic -->
    </div>

    <script>
        // Removed AWS S3; now using public Google Drive file IDs.
        const modelViewer = document.getElementById('model-viewer');
        const panoViewer = document.getElementById('pano-viewer');
        const loadButton = document.getElementById('load-button');
        const qrCodeContainer = document.getElementById('qrcode');
        const loadingScreen = document.getElementById('loading-screen');
        const qrPlaceholder = document.getElementById('qr-placeholder');
        const arButton = document.getElementById('ar-button');
        const save = document.getElementById('save-qr-button');
        
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        let loadedBytes = 0; // retained for progress text reuse


        // Define Arabic and English text content
        const textContent = {
            ar: {
                loading: "جار التحميل...",
                modelPlaceholder: "أدخل معرف الملف",
                loadModel: "تحميل المحتوى",
                saveQr: "حفظ   QR CODE",
                arButton: "عرض في الواقع المعزز",
                toggleLang: "English"
            },
            en: {
                loading: "Loading content...",
                modelPlaceholder: "Enter file ID",
                loadModel: "Load Content",
                saveQr: "Save QR Code",
                arButton: "View in AR",
                toggleLang: "Arabic"
            }
        };

        // Toggle language function
        function toggleLanguage() {
            const currentLang = document.documentElement.lang;
            const newLang = currentLang === "ar" ? "en" : "ar";
            
            document.documentElement.lang = newLang;
            document.body.setAttribute("lang", newLang);

            // Update UI text content based on selected language
            document.getElementById("loading-screen").textContent = textContent[newLang].loading;
            document.getElementById("model-prefix").placeholder = textContent[newLang].modelPlaceholder;
            document.getElementById("load-button").textContent = textContent[newLang].loadModel;
            document.getElementById("save-qr-button").textContent = textContent[newLang].saveQr;
            document.getElementById("ar-button").textContent = textContent[newLang].arButton;
            document.getElementById("lang-toggle").textContent = textContent[newLang].toggleLang;
        }

        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Save QR Code as an image
        document.getElementById('save-qr-button').addEventListener('click', () => {
            const qrCanvas = document.getElementById('qrcode');
            if (qrCanvas) {
                const qrImage = qrCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = qrImage;
                link.download = 'qr-code.png';
                link.click();
            } else {
                alert('QR code not found.');
            }
        });

        function toggleButton() {
            const input = document.getElementById('model-prefix').value;
            loadButton.style.display = input ? 'inline-block' : 'none';
            toggleQRAndARDisplay();
        }


        function toggleQRAndARDisplay() {
            const controls = document.getElementById('controls');
            const isShrunk = controls.classList.contains('shrink');
            const modelLoaded = modelViewer.src !== '' || panoViewer.style.display === 'block';


    if (isShrunk) {
        qrPlaceholder.style.display = 'none';
        arButton.style.display = 'none';
        save.style.display = 'none';
    } else {
        qrPlaceholder.style.display = isMobile ? 'none' : 'block';
        arButton.style.display = isMobile ? 'block' : 'none';
        if (modelLoaded){
            save.style.display = isMobile ? 'none' : 'inline-block';

        }else{
            save.style.display = 'none';
        }
        
        
        
    }
        }
// Update showLoadingScreen to display progress
function showLoadingScreen(show, totalBytes = 0) {
    const loadingText = document.getElementById('loading-screen');
    loadingText.classList.toggle('hidden', !show);

    if (show && totalBytes > 0) {
        const updateProgress = () => {
            loadingText.innerText = `Loading content... ${(loadedBytes / (1024 * 1024)).toFixed(2)} MB of ${(totalBytes / (1024 * 1024)).toFixed(2)} MB`;

            // Continue updating if not hidden
            if (!loadingText.classList.contains('hidden')) {
                requestAnimationFrame(updateProgress);
            }
        };

        updateProgress();
    }
}

// Modify loadModel function to get file size and show progress
function loadModel() {
    const fileId = document.getElementById('model-prefix').value.trim();
    const fileType = document.getElementById('file-type').value;
    if (!fileId) { alert('يرجى إدخال معرف الملف'); return; }
    // Google Drive file IDs غالباً أطوال > 10، لا نفرض طول ثابت.
    // إذا كان المستخدم أدخل رابط كامل مباشر (يحتوي http) نستخدمه كما هو، وإلا نبني رابط Drive
    const fileUrl = fileId.startsWith('http') ? fileId : `https://drive.google.com/uc?export=download&id=${fileId}`;
    showLoadingScreen(true);
    if (fileType === 'model') {
        // نجرب fetch بسيط للتحقق من إمكانية الوصول مع CORS قبل ضبط src
        fetch(fileUrl, { method:'GET' })
          .then(r => {
             if(!r.ok) throw new Error('HTTP '+r.status);
             modelViewer.src = fileUrl;
             modelViewer.style.display = 'block';
             panoViewer.style.display = 'none';
             setTimeout(()=>{ showLoadingScreen(false); }, 8000);
          })
          .catch(err => {
             showLoadingScreen(false);
             displayError(`تعذر تحميل النموذج. السبب المحتمل CORS أو منع الوصول. (${err.message})`);
          });
    } else {
        modelViewer.style.display = 'none';
        panoViewer.style.display = 'block';
        // بانوراما الصور من Drive قد تفشل أيضاً مع CORS؛ نجرب قبل العرض
        fetch(fileUrl, { method:'GET' })
          .then(r => {
             if(!r.ok) throw new Error('HTTP '+r.status);
             pannellum.viewer('pano-viewer', {
            type: 'equirectangular',
            panorama: fileUrl,
            autoLoad: true,
            onload: () => showLoadingScreen(false),
             });
          })
          .catch(err => {
             showLoadingScreen(false);
             displayError(`تعذر تحميل الصورة البانورامية. (${err.message})`);
          });
    }
    // تحديث الرابط للـ QR
    const newUrl = `${window.location.origin}${window.location.pathname}?id=${encodeURIComponent(fileId)}&type=${fileType}`;
    window.history.replaceState(null, '', newUrl);
    qrCodeContainer.innerHTML = "";
    QRCode.toCanvas(qrCodeContainer, newUrl, (error) => {
        if (error) console.error(error);
    });
    if (fileType === 'model') {
        // إذا لم يطلق حدث load (فشل)، نخفي شاشة التحميل بعد مهلة احتياطية
        setTimeout(()=>{ showLoadingScreen(false); }, 8000);
    }
}





        window.addEventListener('DOMContentLoaded', () => {
            const existingId = getQueryParam('id');
            const existingType = getQueryParam('type');
            if (existingId) {
                document.getElementById('model-prefix').value = existingId;
                if (existingType) document.getElementById('file-type').value = existingType;
                toggleButton();
                loadModel();
            }
        });

        modelViewer.addEventListener('load', () => showLoadingScreen(false));
        panoViewer.addEventListener('load', () => showLoadingScreen(false));

        function displayError(msg){
            const box = document.getElementById('error-box');
            box.style.display = 'block';
            box.innerHTML = msg + '<br><br>جرب استضافة بديلة تدعم CORS (raw GitHub أو jsDelivr).';
        }

        modelViewer.addEventListener('ar-status', (event) => {
            if (event.detail.status === 'session-started') {
                console.log('AR session has started.');
            } else if (event.detail.status === 'not-presenting') {
                console.log('AR session has ended.');
            }
        });

        function toggleControls() {
    const controls = document.getElementById('controls');
    if (isMobile && panoViewer.style.display === 'block') {
        controls.classList.add('shrink');
        
        // Wait 300ms for the shrinking animation to complete, then hide
        setTimeout(() => {
            toggleControlsVisibility();
        }, 1500); // Adjust time as per animation duration
    } else {
        controls.classList.toggle('shrink');

    }
    toggleQRAndARDisplay();
}


        function toggleControlsVisibility() {
    const controls = document.getElementById('controls');
    const toggleButton = document.getElementById('controls-toggle-button');

    controls.classList.toggle('hidden');
    toggleButton.classList.toggle('hide-icon'); // Update icon based on visibility
}


        function openAR() {
            if (isMobile && modelViewer.ar) {
                modelViewer.activateAR();
            } else {
                alert('AR is only available on mobile devices.');
            }
        }



</script>
</body>
</html>
