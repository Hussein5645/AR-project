<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model & 360 Image Viewer with AR and AWS S3</title>
    <!-- Removed AWS SDK; adding Google API + jsrsasign for JWT signing -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.5.27/lib/jsrsasign.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pannellum/build/pannellum.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum/build/pannellum.css">

    <style>
        body[lang="ar"] {
            direction: rtl;
        }
    
        body[lang="en"] {
            direction: ltr;
        }
    
        #lang-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            background-color: #444;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            z-index: 20;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
    
        #lang-toggle:hover {
            background-color: #555;
        }
    
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #121212;
            color: #fff;
        }
    
        #model-viewer, #pano-viewer {
            width: 100vw;
            height: 100vh;
            background: #121212;
            display: none;
        }
    
        #controls {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 8px;
            z-index: 10;
            text-align: center;
            width: 90vw;
            max-width: 500px;
            height: 60vh;
            max-height: 400px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: all 0.4s ease;
        }
    
        #controls.shrink {
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 300px;
            height: 70px;
        }
    
        #controls-toggle-button {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #444 url('icon/show.png') center center no-repeat;
            background-size: 20px 20px;
            cursor: pointer;
            z-index: 15;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
    
        #controls-toggle-button:hover {
            background-color: #555;
            transform: scale(1.1);
        }
    
        #upload-Button {
            position: fixed;
            bottom: 10px;
            right: 70px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #444 url('icon/upload.png') center center no-repeat;
            background-size: 20px 20px;
            cursor: pointer;
            z-index: 15;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
    
        #upload-Button:hover {
            background-color: #555;
            transform: scale(1.1);
        }
    
        #controls.hidden {
            display: none;
        }
    
        #controls-toggle-button.hide-icon {
            background-image: url('icon/hide.png');
        }
    
        #q-placeholder {
            display: none;
            width: 100px;
            height: 100px;
            background: #555;
            border-radius: 10px;
            margin: 20px auto;
            position: relative;
        }
    
        input[type="text"] {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: #333;
            color: #fff;
            margin-bottom: 10px;
            margin-right: 50px;
            width: calc(80% - 20px);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
    
        input[type="text"]:focus {
            background: #444;
            box-shadow: 0 0 5px #007bff;
            outline: none;
        }
    
        button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: #fff;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
    
        button:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
    
        #toggle-button {
            background: #444 url('icon/shrink.png') center center no-repeat;
            background-size: 20px 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            margin-top: 10px;
            position: fixed;
            right: 10px;
            top: 8px;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
    
        #toggle-button:hover {
            transform: scale(1.1);
            background-color: #555;
        }
    
        #controls.shrink #toggle-button {
            background-image: url('icon/expand.png');
        }
    
        #ar-button {
            background: #28a745 url('icon/ar.png') 10px center no-repeat;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            padding: 12px 20px;
            border-radius: 5px;
            display: block;
            cursor: pointer;
            background-size: 20px 20px;
            padding-left: 40px;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
    
        #ar-button:hover {
            background: #218838;
            transform: scale(1.05);
        }
    
        #save-qr-button {
            display: none;
            background: #ffc107 url('icon/save.png') 10px center no-repeat;
            color: #000;
            padding: 12px 20px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 230px;
            background-size: 20px 20px;
            padding-left: 40px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
    
        #save-qr-button:hover {
            background: #e0a800;
            transform: scale(1.05);
        }
    
        #qrcode {
            margin-top: 10px;
        }
    
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.5em;
            z-index: 20;
            transition: opacity 0.5s ease;
        }
    
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
    
</head>
<body lang="ar"> <!-- Default to Arabic -->

    <!-- Language toggle button -->
    <button id="lang-toggle" onclick="toggleLanguage()">English</button>

    <div id="loading-screen" class="hidden">جار التحميل...</div> <!-- Loading text in Arabic -->
    
    <!-- Main content: 3D Model Viewer, AR button, QR code placeholder, etc. -->
    <model-viewer id="model-viewer" 
        alt="3D model" 
        auto-rotate 
        camera-controls 
        shadow-intensity="1" 
        exposure="1" 
        ar 
        ar-modes="webxr scene-viewer quick-look"
        ar-status="session-started"
        ar-scale="auto"
        src="">
    </model-viewer>
    <div id="pano-viewer"></div>

    <button id="controls-toggle-button" onclick="toggleControlsVisibility()"></button>
    <button id="upload-Button" onclick="window.location.href='upload.html'"></button>

    <div id="controls">
        <button id="toggle-button" onclick="toggleControls()"></button>
        <input type="text" id="model-prefix" placeholder="أدخل مفتاح النموذج" oninput="toggleButton()"> <!-- Placeholder in Arabic -->
        <button id="load-button" style="display: none;" onclick="loadModel()">تحميل النموذج/الصورة</button>

        <div id="qr-placeholder">
            <canvas id="qrcode" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);   margin-top: 30px;"></canvas>
        </div>
        <div id="save-qr-button">حفظ   QR CODE </div> <!-- Save QR text in Arabic -->
        <button id="ar-button" style="display: none;" onclick="openAR()">عرض في الواقع المعزز</button> <!-- AR button text in Arabic -->
    </div>

        <script>
                /****************************************************
                 * تحذير أمني: وضع المفتاح الخاص في الواجهة الأمامية خطير جداً.
                 * هذا لأغراض الاختبار فقط كما طلبت، يجب إزالته فوراً قبل الإطلاق.
                 ****************************************************/        
                const serviceAccount = {
                    type: "service_account",
                    project_id: "printer-440818",
                    private_key_id: "5b8b59cebbb9a40b3b66035729a6f7c322602dda",
                    private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCX2vCO8UTspLpv\nkDtQovZQzzMRgmUqkTlDrVUVHX1KNECoXVe0951Eylx6GOZFp2scac679NJyJ7MV\nfJiYPGXqq4EfK0onZOXkkJ+lmnSVCkWV80wR2UqnVRPH/fEzCv2pApohJUM795EX\nPORXBNvro7OvlPlsYo/aPy0jyPmdwxitQAHGd7x9OffV7MOf5Qxhqh8Wv04UXSDl\nwMKc85VVGaxHcBhfLPCybom7u9gjZ7cqFoDJ8SmwwV+2JhNKQobWHoCyTJGAGCQ2\nxUG/Tvhf+v+YYPLqu4SZ8Pk8gJycoWAe2CZY4X2vaD6ikuAUISRrIPzynkidORaA\nIApjsgajAgMBAAECggEAQPtPGpQTLwLUxv3c7AY4Sl9IFrOKcBtB+nx3XrhGT5Up\noAKFkCqvsWq5BQSXsXHRi5CZh2PeFDx5zXWKZQbfg/rNH9Xp/w6Vs+fRcU+1mLuT\nCHZa9H5cDFwDQX8hEnsfDg5Pf2SPL1+ixmNnwPcS1vSv5TBmRaOttDJ5sgkEDCZy\nK1qps9a+3UFBkJKW9tMB2D8JQTMVXuhC1BVYxxu1VzfAP0eGue4SeKOSGAChjH6v\nkud6Fs9Cpy+FUeQfdYDMjXp2YAxZLjIJMror7GwcPKcG7CpnakjTvV/TF2QHqjad\npPRO7N6Y0cuYJ9OXVOYKSrsRq6gKL8ScQpF5lOiNsQKBgQDH6K31NstqwR6Jf3H5\nLRS084OYGYNzf5Wjfvv/KRYu0zIdGY+HbfDaZjhJ1Q123nsxARFPSapHLyEwdJt0\n7f7hKNv2XiaycDZJRV+FMY/0Dqyjv2e/AMjZ0rArEWvfC/QZILMwvGrGY0c0oerX\nc2qPPo3ZvRrgt35VXLwrQWyskwKBgQDCdpkBHT/ulSjyeg+AG6XBmGEbxR+Rqfuz\nrOsalBs2qEUoOro49Yk3zlKMyLFHGgcVFif1cEDiHBk/0M6P8OdDYVSGR7oN5101\nJZuyiNNfI0F23HPzcp6zI1gKuB89/Vs/J8nQXtaKBGY20s/CQxI6xzXUFRsR+60I\nxqFYWayXsQKBgQDDcj+xgLL8WndKoumBXoviJjrAWCFmqJRaVup1G2xut1lFjhn/\npINYY5wgw0X4s6fpz0tnI3RxSCjAwSDD/3O0G0iC5KYcywyoMkUjacN+L2KmbZo2\n6cN1A0HtuYind35dmtTWj0AtWh7h3HRH1LWX+uagvPwsO/ot5w6pk7t2NQKBgEb4\nXZLIiAKcsVr9LRcGABKNeDNYV9MjhFborsz+bIggFU0/UaNkCPYy+HGk9P4MA7Ww\nZlju5N8gfh6KKDjkJKK0rNJs7vwQCjZRSWd5BBtelI+6mR6qID0kkwcmd1B6XIjK\nDp9bXVT1khBEE8rEC60j8wM5yK1hep8PTucdox2hAoGBAJOZ897VSZbYq1ckJfX8\nwsk+bOSHWP/r4ClDPfoHPriYB4sWhagMhHU/gq0dlRNbOS3EJrXlPdA2FC9S6OQz\n/IlB21hQBnQDgbtFOQi4mawxUaDrqaVvPIpm6RWQFq+9wdeof41f10yHeBHZo88D\njPFaGGnkLaUUNKHnNqAYWMM6\n-----END PRIVATE KEY-----\n",
                    client_email: "ar-284@printer-440818.iam.gserviceaccount.com",
                    token_uri: "https://oauth2.googleapis.com/token"
                };

                let googleAccessToken = null;
                const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive";

                async function obtainAccessToken() {
                    try {
                        const now = Math.floor(Date.now() / 1000);
                        const header = { alg: "RS256", typ: "JWT" };
                        const claimSet = {
                            iss: serviceAccount.client_email,
                            scope: DRIVE_SCOPE,
                            aud: serviceAccount.token_uri,
                            iat: now,
                            exp: now + 3600
                        };
                        const sHeader = JSON.stringify(header);
                        const sClaim = JSON.stringify(claimSet);
                        const key = KEYUTIL.getKey(serviceAccount.private_key);
                        const jwt = KJUR.jws.JWS.sign("RS256", sHeader, sClaim, key);
                        const body = new URLSearchParams({
                            grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
                            assertion: jwt
                        });
                        const resp = await fetch(serviceAccount.token_uri, {
                            method: "POST",
                            headers: { "Content-Type": "application/x-www-form-urlencoded" },
                            body
                        });
                        const data = await resp.json();
                        if (data.access_token) {
                            googleAccessToken = data.access_token;
                            console.log("Google Drive access token acquired.");
                        } else {
                            console.error("Failed to obtain token", data);
                            alert("فشل الحصول على توكن Google Drive للاختبار.");
                        }
                    } catch (e) {
                        console.error(e);
                        alert("خطأ أثناء إنشاء التوكن.");
                    }
                }

                // استدعاء التهيئة عند التحميل
                window.addEventListener('DOMContentLoaded', obtainAccessToken);
        const modelViewer = document.getElementById('model-viewer');
        const panoViewer = document.getElementById('pano-viewer');
        const loadButton = document.getElementById('load-button');
        const qrCodeContainer = document.getElementById('qrcode');
        const loadingScreen = document.getElementById('loading-screen');
        const qrPlaceholder = document.getElementById('qr-placeholder');
        const arButton = document.getElementById('ar-button');
        const save = document.getElementById('save-qr-button');
        
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        let loadedBytes = 0;


        // Define Arabic and English text content
        const textContent = {
            ar: {
                loading: "جار التحميل...",
                modelPlaceholder: "أدخل مفتاح النموذج",
                loadModel: "تحميل النموذج/الصورة",
                saveQr: "حفظ   QR CODE",
                arButton: "عرض في الواقع المعزز",
                toggleLang: "English"
            },
            en: {
                loading: "Loading content...",
                modelPlaceholder: "Enter model key",
                loadModel: "Load Model/Image",
                saveQr: "Save QR Code",
                arButton: "View in AR",
                toggleLang: "Arabic"
            }
        };

        // Toggle language function
        function toggleLanguage() {
            const currentLang = document.documentElement.lang;
            const newLang = currentLang === "ar" ? "en" : "ar";
            
            document.documentElement.lang = newLang;
            document.body.setAttribute("lang", newLang);

            // Update UI text content based on selected language
            document.getElementById("loading-screen").textContent = textContent[newLang].loading;
            document.getElementById("model-prefix").placeholder = textContent[newLang].modelPlaceholder;
            document.getElementById("load-button").textContent = textContent[newLang].loadModel;
            document.getElementById("save-qr-button").textContent = textContent[newLang].saveQr;
            document.getElementById("ar-button").textContent = textContent[newLang].arButton;
            document.getElementById("lang-toggle").textContent = textContent[newLang].toggleLang;
        }

        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Save QR Code as an image
        document.getElementById('save-qr-button').addEventListener('click', () => {
            const qrCanvas = document.getElementById('qrcode');
            if (qrCanvas) {
                const qrImage = qrCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = qrImage;
                link.download = 'qr-code.png';
                link.click();
            } else {
                alert('QR code not found.');
            }
        });

        function toggleButton() {
            const input = document.getElementById('model-prefix').value;
            loadButton.style.display = input ? 'inline-block' : 'none';
            toggleQRAndARDisplay();
        }


        function toggleQRAndARDisplay() {
            const controls = document.getElementById('controls');
            const isShrunk = controls.classList.contains('shrink');
            const modelLoaded = modelViewer.src !== '' || panoViewer.style.display === 'block';


    if (isShrunk) {
        qrPlaceholder.style.display = 'none';
        arButton.style.display = 'none';
        save.style.display = 'none';
    } else {
        qrPlaceholder.style.display = isMobile ? 'none' : 'block';
        arButton.style.display = isMobile ? 'block' : 'none';
        if (modelLoaded){
            save.style.display = isMobile ? 'none' : 'inline-block';

        }else{
            save.style.display = 'none';
        }
        
        
        
    }
        }
// Update showLoadingScreen to display progress
function showLoadingScreen(show, totalBytes = 0) {
    const loadingText = document.getElementById('loading-screen');
    loadingText.classList.toggle('hidden', !show);

    if (show && totalBytes > 0) {
        const updateProgress = () => {
            loadingText.innerText = `Loading content... ${(loadedBytes / (1024 * 1024)).toFixed(2)} MB of ${(totalBytes / (1024 * 1024)).toFixed(2)} MB`;

            // Continue updating if not hidden
            if (!loadingText.classList.contains('hidden')) {
                requestAnimationFrame(updateProgress);
            }
        };

        updateProgress();
    }
}

// Modify loadModel function to get file size and show progress
                async function loadModel() {
                    const prefix = document.getElementById('model-prefix').value;
                    if (prefix.length !== 10) {
                        alert('يرجى إدخال 10 أحرف بالضبط.');
                        return;
                    }
                    if (!googleAccessToken) {
                        alert('لا يوجد توكن للوصول إلى Google Drive.');
                        return;
                    }
                    try {
                        showLoadingScreen(true);
                        // البحث عن الملف حسب البادئة
                        const query = encodeURIComponent(`name contains '${prefix}_' and trashed=false`);
                        const listResp = await fetch(`https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name,size)`, {
                            headers: { Authorization: `Bearer ${googleAccessToken}` }
                        });
                        const listData = await listResp.json();
                        if (!listData.files || listData.files.length === 0) {
                            alert('لم يتم العثور على ملف بهذا المفتاح.');
                            showLoadingScreen(false);
                            return;
                        }
                        const file = listData.files[0];
                        const fileId = file.id;
                        const fileName = file.name;
                        const ext = fileName.split('.').pop().toLowerCase();
                        const totalBytes = parseInt(file.size || '0', 10);
                        loadedBytes = 0;
                        showLoadingScreen(true, totalBytes);
                        const downloadResp = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                            headers: { Authorization: `Bearer ${googleAccessToken}` }
                        });
                        const blob = await downloadResp.blob();
                        loadedBytes = totalBytes;
                        const objectUrl = URL.createObjectURL(blob);
                        if (ext === 'gltf' || ext === 'glb') {
                            modelViewer.src = objectUrl;
                            modelViewer.style.display = 'block';
                            panoViewer.style.display = 'none';
                        } else if (['jpg','jpeg','png'].includes(ext)) {
                            modelViewer.style.display = 'none';
                            panoViewer.style.display = 'block';
                            pannellum.viewer('pano-viewer', {
                                type: 'equirectangular',
                                panorama: objectUrl,
                                autoLoad: true,
                                onload: () => showLoadingScreen(false)
                            });
                        } else {
                            alert('صيغة ملف غير مدعومة.');
                        }
                        const newUrl = `${window.location.origin}${window.location.pathname}?model=${prefix}`;
                        window.history.replaceState(null, '', newUrl);
                        qrCodeContainer.innerHTML = "";
                        QRCode.toCanvas(qrCodeContainer, newUrl, (error) => { if (error) console.error(error); });
                        showLoadingScreen(false);
                    } catch (e) {
                        console.error(e);
                        alert('خطأ أثناء جلب الملف من Google Drive.');
                        showLoadingScreen(false);
                    }
                }





        window.addEventListener('DOMContentLoaded', () => {
            const modelKey = getQueryParam('model');
            if (modelKey) {
                document.getElementById('model-prefix').value = modelKey;
                toggleButton();
                loadModel();
            }
        });

        modelViewer.addEventListener('load', () => showLoadingScreen(false));
        panoViewer.addEventListener('load', () => showLoadingScreen(false));

        modelViewer.addEventListener('ar-status', (event) => {
            if (event.detail.status === 'session-started') {
                console.log('AR session has started.');
            } else if (event.detail.status === 'not-presenting') {
                console.log('AR session has ended.');
            }
        });

        function toggleControls() {
    const controls = document.getElementById('controls');
    if (isMobile && panoViewer.style.display === 'block') {
        controls.classList.add('shrink');
        
        // Wait 300ms for the shrinking animation to complete, then hide
        setTimeout(() => {
            toggleControlsVisibility();
        }, 1500); // Adjust time as per animation duration
    } else {
        controls.classList.toggle('shrink');

    }
    toggleQRAndARDisplay();
}


        function toggleControlsVisibility() {
    const controls = document.getElementById('controls');
    const toggleButton = document.getElementById('controls-toggle-button');

    controls.classList.toggle('hidden');
    toggleButton.classList.toggle('hide-icon'); // Update icon based on visibility
}


        function openAR() {
            if (isMobile && modelViewer.ar) {
                modelViewer.activateAR();
            } else {
                alert('AR is only available on mobile devices.');
            }
        }



</script>
</body>
</html>
